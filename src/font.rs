use embedded_graphics::{
    pixelcolor::Rgb888,
    prelude::*,
    primitives::{PrimitiveStyle, Rectangle},
};

use crate::framebuffer::FrameBuffer;

pub const DIGIT_WIDTH: usize = 8;
pub const DIGIT_HEIGHT: usize = 12;

pub const DIGITS: [[u8; DIGIT_HEIGHT]; 10] = [
    // 0
    [
        0b01111110, 0b11111111, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011,
        0b11000011, 0b11000011, 0b11000011, 0b11111111, 0b01111110,
    ],
    // 1
    [
        0b00011000, 0b00111000, 0b01111000, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
        0b00011000, 0b00011000, 0b00011000, 0b01111110, 0b01111110,
    ],
    // 2
    [
        0b01111110, 0b11111111, 0b11000011, 0b00000011, 0b00000011, 0b01111111, 0b11111110,
        0b11000000, 0b11000000, 0b11000000, 0b11111111, 0b11111111,
    ],
    // 3
    [
        0b01111110, 0b11111111, 0b11000011, 0b00000011, 0b00000011, 0b00011110, 0b00011110,
        0b00000011, 0b00000011, 0b11000011, 0b11111111, 0b01111110,
    ],
    // 4
    [
        0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11111111, 0b11111111,
        0b00000011, 0b00000011, 0b00000011, 0b00000011, 0b00000011,
    ],
    // 5
    [
        0b11111111, 0b11111111, 0b11000000, 0b11000000, 0b11111110, 0b11111111, 0b00000011,
        0b00000011, 0b00000011, 0b11000011, 0b11111111, 0b01111110,
    ],
    // 6
    [
        0b01111110, 0b11111111, 0b11000011, 0b11000000, 0b11000000, 0b11111110, 0b11111111,
        0b11000011, 0b11000011, 0b11000011, 0b11111111, 0b01111110,
    ],
    // 7
    [
        0b11111111, 0b11111111, 0b00000011, 0b00000011, 0b00000110, 0b00001100, 0b00011000,
        0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
    ],
    // 8
    [
        0b01111110, 0b11111111, 0b11000011, 0b11000011, 0b11000011, 0b01111110, 0b01111110,
        0b11000011, 0b11000011, 0b11000011, 0b11111111, 0b01111110,
    ],
    // 9
    [
        0b01111110, 0b11111111, 0b11000011, 0b11000011, 0b11000011, 0b11111111, 0b01111111,
        0b00000011, 0b00000011, 0b11000011, 0b11111111, 0b01111110,
    ],
];

pub const COLON: [u8; DIGIT_HEIGHT] = [
    0b00, 0b00, 0b00, 0b11, 0b11, 0b00, 0b00, 0b11, 0b11, 0b00, 0b00, 0b00,
];

pub const HYPHEN: [u8; DIGIT_HEIGHT] = [
    0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111110, 0b01111110, 0b00000000,
    0b00000000, 0b00000000, 0b00000000, 0b00000000,
];

pub const LETTERS: [[u8; DIGIT_HEIGHT]; 26] = [
    // A
    [
        0b00111100, 0b01111110, 0b11000011, 0b11000011, 0b11000011, 0b11111111, 0b11111111,
        0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011,
    ],
    // B
    [
        0b11111100, 0b11111110, 0b11000011, 0b11000011, 0b11111110, 0b11111100, 0b11111110,
        0b11000011, 0b11000011, 0b11000011, 0b11111110, 0b11111100,
    ],
    // C
    [
        0b00111100, 0b01111110, 0b11000011, 0b11000000, 0b11000000, 0b11000000, 0b11000000,
        0b11000000, 0b11000000, 0b11000011, 0b01111110, 0b00111100,
    ],
    // D
    [
        0b11111100, 0b11111110, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011,
        0b11000011, 0b11000011, 0b11000011, 0b11111110, 0b11111100,
    ],
    // E
    [
        0b11111111, 0b11111111, 0b11000000, 0b11000000, 0b11111100, 0b11111100, 0b11000000,
        0b11000000, 0b11000000, 0b11000000, 0b11111111, 0b11111111,
    ],
    // F
    [
        0b11111111, 0b11111111, 0b11000000, 0b11000000, 0b11111100, 0b11111100, 0b11000000,
        0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000,
    ],
    // G
    [
        0b00111100, 0b01111110, 0b11000011, 0b11000000, 0b11000000, 0b11001111, 0b11001111,
        0b11000011, 0b11000011, 0b11000011, 0b01111110, 0b00111100,
    ],
    // H
    [
        0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11111111, 0b11111111, 0b11000011,
        0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011,
    ],
    // I
    [
        0b01111110, 0b01111110, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
        0b00011000, 0b00011000, 0b00011000, 0b01111110, 0b01111110,
    ],
    // J
    [
        0b00011111, 0b00011111, 0b00000110, 0b00000110, 0b00000110, 0b00000110, 0b00000110,
        0b00000110, 0b11000110, 0b11000110, 0b01111100, 0b00111000,
    ],
    // K
    [
        0b11000011, 0b11000110, 0b11001100, 0b11011000, 0b11110000, 0b11110000, 0b11011000,
        0b11001100, 0b11000110, 0b11000011, 0b11000011, 0b11000011,
    ],
    // L
    [
        0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000,
        0b11000000, 0b11000000, 0b11000000, 0b11111111, 0b11111111,
    ],
    // M
    [
        0b11000011, 0b11100111, 0b11111111, 0b11011011, 0b11000011, 0b11000011, 0b11000011,
        0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011,
    ],
    // N
    [
        0b11000011, 0b11100011, 0b11110011, 0b11111011, 0b11011111, 0b11001111, 0b11000111,
        0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011,
    ],
    // O
    [
        0b00111100, 0b01111110, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011,
        0b11000011, 0b11000011, 0b11000011, 0b01111110, 0b00111100,
    ],
    // P
    [
        0b11111100, 0b11111110, 0b11000011, 0b11000011, 0b11000011, 0b11111110, 0b11111100,
        0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000,
    ],
    // Q
    [
        0b00111100, 0b01111110, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011,
        0b11001011, 0b11000111, 0b01111110, 0b00111111, 0b00000011,
    ],
    // R
    [
        0b11111100, 0b11111110, 0b11000011, 0b11000011, 0b11000011, 0b11111110, 0b11111100,
        0b11001100, 0b11000110, 0b11000011, 0b11000011, 0b11000011,
    ],
    // S
    [
        0b00111100, 0b01111110, 0b11000011, 0b11000000, 0b01111100, 0b00111110, 0b00000011,
        0b00000011, 0b11000011, 0b11000011, 0b01111110, 0b00111100,
    ],
    // T
    [
        0b11111111, 0b11111111, 0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
        0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
    ],
    // U
    [
        0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011,
        0b11000011, 0b11000011, 0b11000011, 0b01111110, 0b00111100,
    ],
    // V
    [
        0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b01100110,
        0b01100110, 0b00111100, 0b00111100, 0b00011000, 0b00011000,
    ],
    // W
    [
        0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011,
        0b11011011, 0b11111111, 0b11100111, 0b11000011, 0b11000011,
    ],
    // X
    [
        0b11000011, 0b11000011, 0b01100110, 0b00111100, 0b00011000, 0b00011000, 0b00011000,
        0b00111100, 0b01100110, 0b11000011, 0b11000011, 0b11000011,
    ],
    // Y
    [
        0b11000011, 0b11000011, 0b11000011, 0b01100110, 0b00111100, 0b00011000, 0b00011000,
        0b00011000, 0b00011000, 0b00011000, 0b00011000, 0b00011000,
    ],
    // Z
    [
        0b11111111, 0b11111111, 0b00000011, 0b00000110, 0b00001100, 0b00011000, 0b00110000,
        0b01100000, 0b11000000, 0b11000000, 0b11111111, 0b11111111,
    ],
];

fn draw_pixel_block(fb: &mut FrameBuffer, x: i32, y: i32, size: i32, color: Rgb888) {
    Rectangle::new(Point::new(x, y), Size::new(size as u32, size as u32))
        .into_styled(PrimitiveStyle::with_fill(color))
        .draw(fb)
        .unwrap();
}

pub fn draw_digit(fb: &mut FrameBuffer, digit: u8, x: i32, y: i32, pixel_size: i32, color: Rgb888) {
    let bitmap = &DIGITS[digit as usize];
    for (row, &bits) in bitmap.iter().enumerate() {
        for col in 0..DIGIT_WIDTH {
            if (bits >> (DIGIT_WIDTH - 1 - col)) & 1 == 1 {
                draw_pixel_block(
                    fb,
                    x + (col as i32) * pixel_size,
                    y + (row as i32) * pixel_size,
                    pixel_size,
                    color,
                );
            }
        }
    }
}

pub fn draw_colon(
    fb: &mut FrameBuffer,
    x: i32,
    y: i32,
    pixel_size: i32,
    color: Rgb888,
    visible: bool,
) {
    if !visible {
        return;
    }
    for (row, &bits) in COLON.iter().enumerate() {
        for col in 0..2 {
            if (bits >> (1 - col)) & 1 == 1 {
                draw_pixel_block(
                    fb,
                    x + col * pixel_size,
                    y + (row as i32) * pixel_size,
                    pixel_size,
                    color,
                );
            }
        }
    }
}

pub fn draw_hyphen(fb: &mut FrameBuffer, x: i32, y: i32, pixel_size: i32, color: Rgb888) {
    for (row, &bits) in HYPHEN.iter().enumerate() {
        for col in 0..DIGIT_WIDTH {
            if (bits >> (DIGIT_WIDTH - 1 - col)) & 1 == 1 {
                draw_pixel_block(
                    fb,
                    x + (col as i32) * pixel_size,
                    y + (row as i32) * pixel_size,
                    pixel_size,
                    color,
                );
            }
        }
    }
}

pub fn draw_letter(
    fb: &mut FrameBuffer,
    letter: char,
    x: i32,
    y: i32,
    pixel_size: i32,
    color: Rgb888,
) {
    let index = match letter {
        'A'..='Z' => (letter as usize) - ('A' as usize),
        'a'..='z' => (letter as usize) - ('a' as usize),
        _ => return,
    };
    let bitmap = &LETTERS[index];
    for (row, &bits) in bitmap.iter().enumerate() {
        for col in 0..DIGIT_WIDTH {
            if (bits >> (DIGIT_WIDTH - 1 - col)) & 1 == 1 {
                draw_pixel_block(
                    fb,
                    x + (col as i32) * pixel_size,
                    y + (row as i32) * pixel_size,
                    pixel_size,
                    color,
                );
            }
        }
    }
}

pub fn draw_text(fb: &mut FrameBuffer, text: &str, x: i32, y: i32, pixel_size: i32, color: Rgb888) {
    let letter_width = DIGIT_WIDTH as i32 * pixel_size;
    let spacing = pixel_size;
    let mut current_x = x;
    for ch in text.chars() {
        draw_letter(fb, ch, current_x, y, pixel_size, color);
        current_x += letter_width + spacing;
    }
}
